// Traductions inline pour toutes les langues
const taskTranslations = {"fr":{"pageTitle":"TÃ¢ches Ã  accomplir","welcome":"Bienvenue","progress":"Progression","completed":"complÃ©tÃ©es sur 5","congratulations":"ðŸŽ‰ FÃ©licitations !","allTasksCompleted":"Toutes les tÃ¢ches sont terminÃ©es. Merci pour votre professionnalisme !","support":"Support GXO","unreadMessages":"message(s) non lu(s)","tasks":{"task_epi_porte":{"titre":"EPI PortÃ©","description":"Gilet et chaussures de sÃ©curitÃ© obligatoires"},"task_placement_quai":{"titre":"Placement Ã  Quai","description":"VÃ©hicule correctement positionnÃ©"},"task_palette_change":{"titre":"Ã‰change de Palettes","description":"Palette changÃ©e si nÃ©cessaire"},"task_accueil_notifie":{"titre":"Accueil NotifiÃ©","description":"Informations transmises Ã  l'accueil"},"task_clefs_remises":{"titre":"ClÃ©s Remises","description":"ClÃ©s confiÃ©es Ã  l'agent de quai"}},"buttons":{"validate":"Valider","validated":"ValidÃ©","send":"Envoyer","close":"Fermer"},"chat":{"title":"Support GXO","placeholder":"Tapez votre message...","noMessages":"Aucun message pour le moment","you":"Vous","admin":"Support"}},"it":{"pageTitle":"Compiti da completare","welcome":"Benvenuto","progress":"Progresso","completed":"completate su 5","congratulations":"ðŸŽ‰ Congratulazioni!","allTasksCompleted":"Tutti i compiti sono completati. Grazie per la tua professionalitÃ !","support":"Supporto GXO","unreadMessages":"messaggio/i non letto/i","tasks":{"task_epi_porte":{"titre":"DPI Indossati","description":"Giubbotto e scarpe di sicurezza obbligatori"},"task_placement_quai":{"titre":"Posizionamento alla Banchina","description":"Veicolo correttamente posizionato"},"task_palette_change":{"titre":"Scambio di Pallet","description":"Pallet scambiato se necessario"},"task_accueil_notifie":{"titre":"Accoglienza Notificata","description":"Informazioni trasmesse alla reception"},"task_clefs_remises":{"titre":"Chiavi Consegnate","description":"Chiavi affidate all'agente della banchina"}},"buttons":{"validate":"Convalida","validated":"Convalidato","send":"Invia","close":"Chiudi"},"chat":{"title":"Supporto GXO","placeholder":"Scrivi il tuo messaggio...","noMessages":"Nessun messaggio per ora","you":"Tu","admin":"Supporto"}},"nl":{"pageTitle":"Uit te voeren taken","welcome":"Welkom","progress":"Voortgang","completed":"voltooid van 5","congratulations":"ðŸŽ‰ Gefeliciteerd!","allTasksCompleted":"Alle taken zijn voltooid. Bedankt voor uw professionaliteit!","support":"GXO Ondersteuning","unreadMessages":"ongelezen bericht(en)","tasks":{"task_epi_porte":{"titre":"PBM Gedragen","description":"Vest en veiligheidsschoenen verplicht"},"task_placement_quai":{"titre":"Plaatsing aan Kade","description":"Voertuig correct gepositioneerd"},"task_palette_change":{"titre":"Palletuitwisseling","description":"Pallet gewisseld indien nodig"},"task_accueil_notifie":{"titre":"Receptie Gemeld","description":"Informatie doorgegeven aan receptie"},"task_clefs_remises":{"titre":"Sleutels Ingeleverd","description":"Sleutels toevertrouwd aan kadeagent"}},"buttons":{"validate":"Valideren","validated":"Gevalideerd","send":"Verzenden","close":"Sluiten"},"chat":{"title":"GXO Ondersteuning","placeholder":"Typ uw bericht...","noMessages":"Nog geen berichten","you":"U","admin":"Ondersteuning"}},"de":{"pageTitle":"Zu erledigende Aufgaben","welcome":"Willkommen","progress":"Fortschritt","completed":"abgeschlossen von 5","congratulations":"ðŸŽ‰ GlÃ¼ckwunsch!","allTasksCompleted":"Alle Aufgaben sind erledigt. Vielen Dank fÃ¼r Ihre ProfessionalitÃ¤t!","support":"GXO Support","unreadMessages":"ungelesene Nachricht(en)","tasks":{"task_epi_porte":{"titre":"PSA Getragen","description":"Weste und Sicherheitsschuhe obligatorisch"},"task_placement_quai":{"titre":"Positionierung am Dock","description":"Fahrzeug korrekt positioniert"},"task_palette_change":{"titre":"Palettentausch","description":"Palette bei Bedarf getauscht"},"task_accueil_notifie":{"titre":"Empfang Benachrichtigt","description":"Informationen an Empfang Ã¼bermittelt"},"task_clefs_remises":{"titre":"SchlÃ¼ssel Ãœbergeben","description":"SchlÃ¼ssel an Dock-Mitarbeiter Ã¼bergeben"}},"buttons":{"validate":"BestÃ¤tigen","validated":"BestÃ¤tigt","send":"Senden","close":"SchlieÃŸen"},"chat":{"title":"GXO Support","placeholder":"Geben Sie Ihre Nachricht ein...","noMessages":"Noch keine Nachrichten","you":"Sie","admin":"Support"}},"bg":{"pageTitle":"Ð—Ð°Ð´Ð°Ñ‡Ð¸ Ð·Ð° Ð¸Ð·Ð¿ÑŠÐ»Ð½ÐµÐ½Ð¸Ðµ","welcome":"Ð”Ð¾Ð±Ñ€Ðµ Ð´Ð¾ÑˆÐ»Ð¸","progress":"ÐÐ°Ð¿Ñ€ÐµÐ´ÑŠÐº","completed":"Ð·Ð°Ð²ÑŠÑ€ÑˆÐµÐ½Ð¸ Ð¾Ñ‚ 5","congratulations":"ðŸŽ‰ ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ!","allTasksCompleted":"Ð’ÑÐ¸Ñ‡ÐºÐ¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸ ÑÐ° Ð·Ð°Ð²ÑŠÑ€ÑˆÐµÐ½Ð¸. Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð¸Ð¼ Ð·Ð° Ð¿Ñ€Ð¾Ñ„ÐµÑÐ¸Ð¾Ð½Ð°Ð»Ð¸Ð·Ð¼Ð°!","support":"GXO ÐŸÐ¾Ð´Ð´Ñ€ÑŠÐ¶ÐºÐ°","unreadMessages":"Ð½ÐµÐ¿Ñ€Ð¾Ñ‡ÐµÑ‚ÐµÐ½Ð¾/Ð¸ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ/Ñ","tasks":{"task_epi_porte":{"titre":"ÐÐ¾ÑÐµÐ½Ð¸ Ð›ÐŸÐ¡","description":"Ð–Ð¸Ð»ÐµÑ‚ÐºÐ° Ð¸ Ð·Ð°Ñ‰Ð¸Ñ‚Ð½Ð¸ Ð¾Ð±ÑƒÐ²ÐºÐ¸ Ð·Ð°Ð´ÑŠÐ»Ð¶Ð¸Ñ‚ÐµÐ»Ð½Ð¸"},"task_placement_quai":{"titre":"ÐŸÐ¾ÑÑ‚Ð°Ð²ÑÐ½Ðµ Ð½Ð° ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°","description":"ÐŸÑ€ÐµÐ²Ð¾Ð·Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð½Ð¾ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¾Ð½Ð¸Ñ€Ð°Ð½Ð¾"},"task_palette_change":{"titre":"Ð¡Ð¼ÑÐ½Ð° Ð½Ð° ÐŸÐ°Ð»ÐµÑ‚Ð¸","description":"ÐŸÐ°Ð»ÐµÑ‚ ÑÐ¼ÐµÐ½ÐµÐ½ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚"},"task_accueil_notifie":{"titre":"Ð ÐµÑ†ÐµÐ¿Ñ†Ð¸Ñ Ð£Ð²ÐµÐ´Ð¾Ð¼ÐµÐ½Ð°","description":"Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð°Ð´ÐµÐ½Ð° Ð½Ð° Ñ€ÐµÑ†ÐµÐ¿Ñ†Ð¸Ñ"},"task_clefs_remises":{"titre":"ÐšÐ»ÑŽÑ‡Ð¾Ð²Ðµ ÐŸÑ€ÐµÐ´Ð°Ð´ÐµÐ½Ð¸","description":"ÐšÐ»ÑŽÑ‡Ð¾Ð²Ðµ Ð¿Ñ€ÐµÐ´Ð°Ð´ÐµÐ½Ð¸ Ð½Ð° ÑÐ»ÑƒÐ¶Ð¸Ñ‚ÐµÐ» Ð½Ð° Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°"}},"buttons":{"validate":"ÐŸÐ¾Ñ‚Ð²ÑŠÑ€Ð´Ð¸","validated":"ÐŸÐ¾Ñ‚Ð²ÑŠÑ€Ð´ÐµÐ½Ð¾","send":"Ð˜Ð·Ð¿Ñ€Ð°Ñ‚Ð¸","close":"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸"},"chat":{"title":"GXO ÐŸÐ¾Ð´Ð´Ñ€ÑŠÐ¶ÐºÐ°","placeholder":"ÐÐ°Ð¿Ð¸ÑˆÐµÑ‚Ðµ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÑ‚Ð¾ ÑÐ¸...","noMessages":"Ð’ÑÐµ Ð¾Ñ‰Ðµ Ð½ÑÐ¼Ð° ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ñ","you":"Ð’Ð¸Ðµ","admin":"ÐŸÐ¾Ð´Ð´Ñ€ÑŠÐ¶ÐºÐ°"}},"cs":{"pageTitle":"Ãškoly k dokonÄenÃ­","welcome":"VÃ­tejte","progress":"Pokrok","completed":"dokonÄeno z 5","congratulations":"ðŸŽ‰ Gratulujeme!","allTasksCompleted":"VÅ¡echny Ãºkoly jsou dokonÄeny. DÄ›kujeme za vaÅ¡i profesionalitu!","support":"GXO Podpora","unreadMessages":"nepÅ™eÄtenÃ¡ zprÃ¡va/y","tasks":{"task_epi_porte":{"titre":"OOPP NasazenÃ©","description":"Vesta a bezpeÄnostnÃ­ obuv povinnÃ©"},"task_placement_quai":{"titre":"UmÃ­stÄ›nÃ­ u Rampy","description":"Vozidlo sprÃ¡vnÄ› umÃ­stÄ›no"},"task_palette_change":{"titre":"VÃ½mÄ›na Palet","description":"Paleta vymÄ›nÄ›na v pÅ™Ã­padÄ› potÅ™eby"},"task_accueil_notifie":{"titre":"Recepce InformovÃ¡na","description":"Informace pÅ™edÃ¡ny recepci"},"task_clefs_remises":{"titre":"KlÃ­Äe OdevzdÃ¡ny","description":"KlÃ­Äe svÄ›Å™eny pracovnÃ­kovi rampy"}},"buttons":{"validate":"Potvrdit","validated":"Potvrzeno","send":"Odeslat","close":"ZavÅ™Ã­t"},"chat":{"title":"GXO Podpora","placeholder":"NapiÅ¡te svou zprÃ¡vu...","noMessages":"ZatÃ­m Å¾Ã¡dnÃ© zprÃ¡vy","you":"Vy","admin":"Podpora"}},"da":{"pageTitle":"Opgaver at udfÃ¸re","welcome":"Velkommen","progress":"Fremskridt","completed":"fuldfÃ¸rt af 5","congratulations":"ðŸŽ‰ Tillykke!","allTasksCompleted":"Alle opgaver er fuldfÃ¸rt. Tak for din professionalisme!","support":"GXO Support","unreadMessages":"ulÃ¦st(e) besked(er)","tasks":{"task_epi_porte":{"titre":"PPE BÃ¥ret","description":"Vest og sikkerhedssko obligatorisk"},"task_placement_quai":{"titre":"Placering ved Kaj","description":"KÃ¸retÃ¸j korrekt placeret"},"task_palette_change":{"titre":"Palleudveksling","description":"Palle udskiftet om nÃ¸dvendigt"},"task_accueil_notifie":{"titre":"Reception Underrettet","description":"Information overfÃ¸rt til reception"},"task_clefs_remises":{"titre":"NÃ¸gler Afleveret","description":"NÃ¸gler betroet til kajagent"}},"buttons":{"validate":"Validere","validated":"Valideret","send":"Send","close":"Luk"},"chat":{"title":"GXO Support","placeholder":"Skriv din besked...","noMessages":"Ingen beskeder endnu","you":"Du","admin":"Support"}},"fi":{"pageTitle":"Suoritettavat tehtÃ¤vÃ¤t","welcome":"Tervetuloa","progress":"Edistyminen","completed":"valmistunut 5:stÃ¤","congratulations":"ðŸŽ‰ Onnittelut!","allTasksCompleted":"Kaikki tehtÃ¤vÃ¤t on suoritettu. Kiitos ammattimaisuudestasi!","support":"GXO Tuki","unreadMessages":"lukematon/lukemattomat viesti(t)","tasks":{"task_epi_porte":{"titre":"HVV Puettu","description":"Liivi ja turvakengÃ¤t pakollisia"},"task_placement_quai":{"titre":"Sijoitus Laiturille","description":"Ajoneuvo oikein sijoitettu"},"task_palette_change":{"titre":"Lavasiirto","description":"Lava vaihdettu tarvittaessa"},"task_accueil_notifie":{"titre":"Vastaanotto Ilmoitettu","description":"Tiedot vÃ¤litetty vastaanotolle"},"task_clefs_remises":{"titre":"Avaimet Luovutettu","description":"Avaimet uskottu laituriagentille"}},"buttons":{"validate":"Vahvista","validated":"Vahvistettu","send":"LÃ¤hetÃ¤","close":"Sulje"},"chat":{"title":"GXO Tuki","placeholder":"Kirjoita viestisi...","noMessages":"Ei vielÃ¤ viestejÃ¤","you":"SinÃ¤","admin":"Tuki"}},"hr":{"pageTitle":"Zadaci za obavljanje","welcome":"DobrodoÅ¡li","progress":"Napredak","completed":"dovrÅ¡eno od 5","congratulations":"ðŸŽ‰ ÄŒestitamo!","allTasksCompleted":"Svi zadaci su dovrÅ¡eni. Hvala na vaÅ¡oj profesionalnosti!","support":"GXO PodrÅ¡ka","unreadMessages":"neproÄitana/e poruka/e","tasks":{"task_epi_porte":{"titre":"OZO NoÅ¡eno","description":"Prsluk i zaÅ¡titne cipele obavezni"},"task_placement_quai":{"titre":"Postavljanje na Rivu","description":"Vozilo pravilno pozicionirano"},"task_palette_change":{"titre":"Zamjena Paleta","description":"Paleta zamijenjena ako je potrebno"},"task_accueil_notifie":{"titre":"Recepcija ObavijeÅ¡tena","description":"Informacije proslijeÄ‘ene recepciji"},"task_clefs_remises":{"titre":"KljuÄevi Predani","description":"KljuÄevi povjereni agentu rive"}},"buttons":{"validate":"Potvrditi","validated":"PotvrÄ‘eno","send":"PoÅ¡alji","close":"Zatvori"},"chat":{"title":"GXO PodrÅ¡ka","placeholder":"UpiÅ¡ite svoju poruku...","noMessages":"JoÅ¡ nema poruka","you":"Vi","admin":"PodrÅ¡ka"}},"pl":{"pageTitle":"Zadania do wykonania","welcome":"Witaj","progress":"PostÄ™p","completed":"ukoÅ„czono z 5","congratulations":"ðŸŽ‰ Gratulacje!","allTasksCompleted":"Wszystkie zadania sÄ… ukoÅ„czone. DziÄ™kujemy za profesjonalizm!","support":"Wsparcie GXO","unreadMessages":"nieprzeczytana/e wiadomoÅ›Ä‡/ci","tasks":{"task_epi_porte":{"titre":"ÅšOI Noszony","description":"Kamizelka i obuwie ochronne obowiÄ…zkowe"},"task_placement_quai":{"titre":"Ustawienie przy Doku","description":"Pojazd prawidÅ‚owo ustawiony"},"task_palette_change":{"titre":"Wymiana Palet","description":"Paleta wymieniona w razie potrzeby"},"task_accueil_notifie":{"titre":"Recepcja Powiadomiona","description":"Informacje przekazane recepcji"},"task_clefs_remises":{"titre":"Klucze Oddane","description":"Klucze powierzone agentowi doku"}},"buttons":{"validate":"ZatwierdÅº","validated":"Zatwierdzone","send":"WyÅ›lij","close":"Zamknij"},"chat":{"title":"Wsparcie GXO","placeholder":"Wpisz swojÄ… wiadomoÅ›Ä‡...","noMessages":"Brak wiadomoÅ›ci","you":"Ty","admin":"Wsparcie"}},"pt":{"pageTitle":"Tarefas a realizar","welcome":"Bem-vindo","progress":"Progresso","completed":"concluÃ­das de 5","congratulations":"ðŸŽ‰ ParabÃ©ns!","allTasksCompleted":"Todas as tarefas estÃ£o concluÃ­das. Obrigado pelo profissionalismo!","support":"Suporte GXO","unreadMessages":"mensagem(ns) nÃ£o lida(s)","tasks":{"task_epi_porte":{"titre":"EPI Usado","description":"Colete e sapatos de seguranÃ§a obrigatÃ³rios"},"task_placement_quai":{"titre":"Posicionamento no Cais","description":"VeÃ­culo corretamente posicionado"},"task_palette_change":{"titre":"Troca de Paletes","description":"Palete trocada se necessÃ¡rio"},"task_accueil_notifie":{"titre":"RecepÃ§Ã£o Notificada","description":"InformaÃ§Ãµes transmitidas Ã  recepÃ§Ã£o"},"task_clefs_remises":{"titre":"Chaves Entregues","description":"Chaves confiadas ao agente do cais"}},"buttons":{"validate":"Validar","validated":"Validado","send":"Enviar","close":"Fechar"},"chat":{"title":"Suporte GXO","placeholder":"Digite sua mensagem...","noMessages":"Nenhuma mensagem ainda","you":"VocÃª","admin":"Suporte"}},"ro":{"pageTitle":"Sarcini de Ã®ndeplinit","welcome":"Bine aÈ›i venit","progress":"Progres","completed":"finalizate din 5","congratulations":"ðŸŽ‰ FelicitÄƒri!","allTasksCompleted":"Toate sarcinile sunt finalizate. VÄƒ mulÈ›umim pentru profesionalism!","support":"Suport GXO","unreadMessages":"mesaj(e) necitit(e)","tasks":{"task_epi_porte":{"titre":"EIP Purtat","description":"VestÄƒ È™i Ã®ncÄƒlÈ›Äƒminte de protecÈ›ie obligatorii"},"task_placement_quai":{"titre":"PoziÈ›ionare la Chei","description":"Vehicul corect poziÈ›ionat"},"task_palette_change":{"titre":"Schimb de PaleÈ›i","description":"Palet schimbat dacÄƒ este necesar"},"task_accueil_notifie":{"titre":"RecepÈ›ie NotificatÄƒ","description":"InformaÈ›ii transmise la recepÈ›ie"},"task_clefs_remises":{"titre":"Chei Predate","description":"Chei Ã®ncredinÈ›ate agentului de chei"}},"buttons":{"validate":"ValideazÄƒ","validated":"Validat","send":"Trimite","close":"ÃŽnchide"},"chat":{"title":"Suport GXO","placeholder":"TastaÈ›i mesajul dumneavoastrÄƒ...","noMessages":"Niciun mesaj deocamdatÄƒ","you":"DumneavoastrÄƒ","admin":"Suport"}},"en":{"pageTitle":"Tasks to complete","welcome":"Welcome","progress":"Progress","completed":"completed out of 5","congratulations":"ðŸŽ‰ Congratulations!","allTasksCompleted":"All tasks are completed. Thank you for your professionalism!","support":"GXO Support","unreadMessages":"unread message(s)","tasks":{"task_epi_porte":{"titre":"PPE Worn","description":"Vest and safety shoes mandatory"},"task_placement_quai":{"titre":"Dock Placement","description":"Vehicle correctly positioned"},"task_palette_change":{"titre":"Pallet Exchange","description":"Pallet changed if necessary"},"task_accueil_notifie":{"titre":"Reception Notified","description":"Information transmitted to reception"},"task_clefs_remises":{"titre":"Keys Handed Over","description":"Keys entrusted to dock agent"}},"buttons":{"validate":"Validate","validated":"Validated","send":"Send","close":"Close"},"chat":{"title":"GXO Support","placeholder":"Type your message...","noMessages":"No messages yet","you":"You","admin":"Support"}}};

// RÃ©cupÃ©rer l'ID du chauffeur et la langue depuis l'URL
const urlParams = new URLSearchParams(window.location.search);
const chauffeurId = urlParams.get('id');
const lang = urlParams.get('lang') || 'fr';

if (!chauffeurId) {
  window.location.href = '/chauffeur/langue';
}

// RÃ©cupÃ©rer les traductions
const t = taskTranslations[lang] || taskTranslations['fr'];

// Appliquer les traductions au DOM
function applyTranslations() {
  // Traductions simples (texte)
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const keys = key.split('.');
    let value = t;
    for (const k of keys) {
      value = value[k];
    }
    if (value) el.textContent = value;
  });
  
  // Traductions pour les placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    const keys = key.split('.');
    let value = t;
    for (const k of keys) {
      value = value[k];
    }
    if (value) el.setAttribute('placeholder', value);
  });
  
  // Mettre Ã  jour le titre
  document.title = `${t.pageTitle} - GXO`;
}

// Appliquer les traductions au chargement
document.addEventListener('DOMContentLoaded', applyTranslations);

// Configuration des 5 tÃ¢ches
const TACHES = [
  {
    id: 'task_epi_porte',
    titre: t.tasks.task_epi_porte.titre,
    description: t.tasks.task_epi_porte.description,
    icon: 'vest',
    couleur: 'blue'
  },
  {
    id: 'task_placement_quai',
    titre: t.tasks.task_placement_quai.titre,
    description: t.tasks.task_placement_quai.description,
    icon: 'truck-loading',
    couleur: 'purple'
  },
  {
    id: 'task_palette_change',
    titre: t.tasks.task_palette_change.titre,
    description: t.tasks.task_palette_change.description,
    icon: 'pallet',
    couleur: 'yellow'
  },
  {
    id: 'task_accueil_notifie',
    titre: t.tasks.task_accueil_notifie.titre,
    description: t.tasks.task_accueil_notifie.description,
    icon: 'bell',
    couleur: 'green'
  },
  {
    id: 'task_clefs_remises',
    titre: t.tasks.task_clefs_remises.titre,
    description: t.tasks.task_clefs_remises.description,
    icon: 'key',
    couleur: 'red'
  }
];

let chauffeurData = null;
let updateInterval = null;

// Charger les donnÃ©es du chauffeur
async function loadChauffeurInfo() {
  try {
    const response = await fetch(`/api/chauffeur/progression?id=${chauffeurId}`);
    const data = await response.json();
    
    if (response.ok && data.success) {
      chauffeurData = data;
      
      // Mettre Ã  jour les infos du header
      document.getElementById('chauffeur-pseudo').textContent = data.pseudo || 'Chauffeur';
      document.getElementById('chauffeur-entreprise').textContent = data.entreprise || '';
      document.getElementById('chauffeur-quai').textContent = data.numero_quai || '--';
      
      // Calculer la progression
      const progression = calculerProgression(data);
      document.getElementById('progression-percent').textContent = progression + '%';
      document.getElementById('barre-progression').style.width = progression + '%';
      
      // Afficher les tÃ¢ches
      renderTaches(data);
      
      // VÃ©rifier si tout est complÃ©tÃ©
      if (progression === 100) {
        document.getElementById('message-complet').classList.remove('hidden');
      }
    }
  } catch (error) {
    console.error('Erreur chargement chauffeur:', error);
  }
}

// Calculer la progression (nombre de tÃ¢ches complÃ©tÃ©es / 5 * 100)
function calculerProgression(data) {
  let completed = 0;
  TACHES.forEach(tache => {
    if (data[tache.id] === 1 || data[tache.id] === true) {
      completed++;
    }
  });
  return Math.round((completed / TACHES.length) * 100);
}

// Afficher les tÃ¢ches
function renderTaches(data) {
  const container = document.getElementById('liste-taches');
  
  container.innerHTML = TACHES.map(tache => {
    const isCompleted = data[tache.id] === 1 || data[tache.id] === true;
    const couleurClass = {
      blue: 'from-blue-500 to-blue-600',
      purple: 'from-purple-500 to-purple-600',
      yellow: 'from-yellow-500 to-yellow-600',
      green: 'from-green-500 to-green-600',
      red: 'from-red-500 to-red-600'
    }[tache.couleur];
    
    const borderClass = {
      blue: 'border-blue-200',
      purple: 'border-purple-200',
      yellow: 'border-yellow-200',
      green: 'border-green-200',
      red: 'border-red-200'
    }[tache.couleur];
    
    return `
      <div class="bg-white rounded-xl shadow-lg p-6 border-2 ${isCompleted ? 'border-green-500 opacity-75' : borderClass}">
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-start gap-4 flex-1">
            <div class="w-12 h-12 bg-gradient-to-r ${couleurClass} rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-${tache.icon} text-white text-xl"></i>
            </div>
            <div class="flex-1">
              <h4 class="text-xl font-bold text-gray-800 mb-1">${tache.titre}</h4>
              <p class="text-gray-600 text-sm">${tache.description}</p>
            </div>
          </div>
          ${isCompleted ? `
            <div class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
              <i class="fas fa-check"></i>
              ${t.buttons.validated}
            </div>
          ` : `
            <button 
              onclick="validerTache('${tache.id}')"
              class="bg-gradient-to-r ${couleurClass} text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition-all flex items-center gap-2"
            >
              <i class="fas fa-check-circle"></i>
              ${t.buttons.validate}
            </button>
          `}
        </div>
      </div>
    `;
  }).join('');
}

// Valider une tÃ¢che
async function validerTache(taskId) {
  try {
    const response = await fetch('/api/chauffeur/valider-tache', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chauffeur_id: chauffeurId,
        tache: taskId
      })
    });
    
    if (response.ok) {
      // Recharger les donnÃ©es
      await loadChauffeurInfo();
    }
  } catch (error) {
    console.error('Erreur validation tÃ¢che:', error);
  }
}

// Chat / Messages
const modalChat = document.getElementById('modal-chat');
const btnChat = document.getElementById('btn-chat');
const btnFermerChat = document.getElementById('btn-fermer-chat');
const formMessage = document.getElementById('form-message');
const messageInput = document.getElementById('message-input');
const messagesContainer = document.getElementById('messages-container');
const chatBadge = document.getElementById('chat-badge');

btnChat.addEventListener('click', () => {
  modalChat.classList.remove('hidden');
  loadMessages();
});

btnFermerChat.addEventListener('click', () => {
  modalChat.classList.add('hidden');
});

formMessage.addEventListener('submit', async (e) => {
  e.preventDefault();
  const message = messageInput.value.trim();
  
  if (message) {
    try {
      const response = await fetch('/api/chauffeur/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chauffeur_id: chauffeurId,
          message: message
        })
      });
      
      if (response.ok) {
        messageInput.value = '';
        await loadMessages();
      }
    } catch (error) {
      console.error('Erreur envoi message:', error);
    }
  }
});

async function loadMessages() {
  try {
    const response = await fetch(`/api/chauffeur/chat?id=${chauffeurId}&viewer=chauffeur`);
    const data = await response.json();
    
    if (response.ok && data.success && data.messages) {
      // Compter les messages non lus de l'admin
      const unreadCount = data.messages.filter(m => m.sender === 'admin' && m.read === 0).length;
      
      if (unreadCount > 0) {
        chatBadge.textContent = unreadCount;
        chatBadge.classList.remove('hidden');
      } else {
        chatBadge.classList.add('hidden');
      }
      
      // Afficher les messages
      if (data.messages.length > 0) {
        messagesContainer.innerHTML = data.messages.map(msg => `
          <div class="flex ${msg.sender === 'chauffeur' ? 'justify-end' : 'justify-start'}">
            <div class="${msg.sender === 'chauffeur' ? 'bg-[#FF5A1A] text-white' : 'bg-gray-100 text-gray-800'} rounded-xl px-4 py-3 max-w-[80%]">
              <p>${msg.message}</p>
              <div class="text-xs mt-1 opacity-75">
                ${new Date(msg.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
              </div>
            </div>
          </div>
        `).join('');
        
        // Marquer les messages comme lus
        if (unreadCount > 0) {
          await fetch('/api/chauffeur/chat/mark-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chauffeur_id: chauffeurId })
          });
        }
        
        // Scroll vers le bas
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } else {
        messagesContainer.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-comments text-4xl mb-3 text-gray-300"></i>
            <p>Aucun message</p>
          </div>
        `;
      }
    }
  } catch (error) {
    console.error('Erreur chargement messages:', error);
  }
}

// Heartbeat pour indiquer que le chauffeur est en ligne
async function sendHeartbeat() {
  try {
    await fetch('/api/chat/heartbeat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chauffeur_id: chauffeurId,
        page_url: window.location.href
      })
    });
  } catch (error) {
    console.error('Erreur heartbeat:', error);
  }
}

// Initialisation
loadChauffeurInfo();

// Envoyer heartbeat immÃ©diatement
sendHeartbeat();

// Mise Ã  jour automatique toutes les 5 secondes
updateInterval = setInterval(() => {
  loadChauffeurInfo();
  if (!modalChat.classList.contains('hidden')) {
    loadMessages();
  }
  // Envoyer heartbeat pour indiquer que le chauffeur est toujours en ligne
  sendHeartbeat();
}, 5000);

// Make validerTache global
window.validerTache = validerTache;
